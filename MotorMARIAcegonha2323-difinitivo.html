<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Motor Cegonha Atualizado</title>
</head>
<body>

<div id="conteudo" class="maria">
    <cegonha>
        s1 = "o sonho "
        s2 = "a sombra "
        s3 = "a luz "

        v1 = "abraça "
        v2 = "transforma "
        v3 = "desperta "

        o1 = "o infinito"
        
        resultado = s3 + v2 + o1
        cegonha(resultado)
        cegonha("<br>")

        -- Exemplo solicitado: maria 23 vezes --
        m = "maria "
        repeticao = m * 23
        cegonha(repeticao)
    </cegonha>
</div>

<!-- Motor Cegonha Atualizado -->
<script>
    function repetir(str, n) {
        n = Math.floor(Number(n)) || 0;
        if (n < 0 || n > 1000) n = 0;
        return String(str).repeat(n);
    }

    function sandboxCegonha(html) {
        const proibidos = [/window\b/i, /document\b/i, /eval\b/i, /Function\b/i, /onload\b/i, /onerror\b/i, /<script/i, /<\/script/i];
        return html.replace(/<cegonha>([\s\S]*?)<\/cegonha>/g, function(_, codigo) {
            for (let r of proibidos) { if (r.test(codigo)) return "<div style='color:red'>ERRO: Sandbox</div>"; }
            return "<cegonha>" + codigo + "</cegonha>";
        });
    }

    function isExpressaoSegura(expr) {
        // Agora aceita + - * / . e %
        return /^[0-9+\-*/().\s%^]*$/.test(expr);
    }

    function avaliarExpressaoSegura(expr) {
        expr = String(expr).trim();
        if (!isExpressaoSegura(expr) || expr === "") return 0;
        try { return Function('"use strict";return(' + expr + ')')(); }
        catch (e) { return 0; }
    }

    function avaliarValor(valor, vars) {
        valor = valor.trim();

        // Trata strings literais
        if ((valor.startsWith('"') && valor.endsWith('"')) || (valor.startsWith("'") && valor.endsWith("'"))) {
            return valor.slice(1, -1);
        }

        // SUPORTE PARA REPETIÇÃO (string * numero)
        if (valor.includes("*")) {
            let partes = valor.split("*").map(p => p.trim());
            let vEsquerda = avaliarValor(partes[0], vars);
            let vDireita = avaliarValor(partes[1], vars);
            
            if (isNaN(vEsquerda) && !isNaN(vDireita)) return repetir(vEsquerda, vDireita);
            if (!isNaN(vEsquerda) && isNaN(vDireita)) return repetir(vDireita, vEsquerda);
            return avaliarExpressaoSegura(valor);
        }

        // CONCATENAÇÃO E OPERADORES (+ e .)
        if (valor.includes("+") || valor.includes(".")) {
            let separador = valor.includes("+") ? "+" : ".";
            let partes = valor.split(separador).map(p => p.trim());
            let resultado = "";
            for (let p of partes) {
                resultado += avaliarValor(p, vars);
            }
            return resultado;
        }

        // VARIÁVEL SIMPLES
        if (/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(valor) && valor in vars) {
            return vars[valor];
        }

        // CÁLCULO NUMÉRICO (incluindo / e outros)
        if (isExpressaoSegura(valor)) {
            return avaliarExpressaoSegura(valor);
        }

        return "";
    }

    function executarCegonhaSeguro(html) {
        return html.replace(/<cegonha>([\s\S]*?)<\/cegonha>/g, function(_, codigo) {
            let vars = {};
            let saida = "";
            let linhas = codigo.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "" && !l.startsWith("--"));

            linhas.forEach(l => {
                if (l.includes("=") && !l.startsWith("cegonha(")) {
                    let partes = l.split("=");
                    let nome = partes[0].trim();
                    let valor = partes.slice(1).join("=").trim();
                    if (/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(nome)) {
                        vars[nome] = avaliarValor(valor, vars);
                    }
                } else if (l.startsWith("cegonha(")) {
                    let conteudo = l.replace(/^cegonha\s*\(|\)$/g, "").trim();
                    saida += avaliarValor(conteudo, vars);
                }
            });
            return "<div style='padding:10px;background:#eee;border-left:4px solid purple;word-wrap:break-word;'>" + saida + "</div>";
        });
    }

    (function(oldOnload) {
        window.onload = function(e) {
            if (typeof oldOnload === "function") { try { oldOnload(e); } catch (err) {} }
            document.querySelectorAll("div[id^='conteudo']").forEach(function(div) {
                var seguro = sandboxCegonha(div.innerHTML);
                div.innerHTML = executarCegonhaSeguro(seguro);
            });
        };
    })(window.onload);
</script>

</body>
</html>